env:
  global:
  - PERL5LIB=/usr/share/perl5
language: python
dist: xenial
python:
- '2.7'
branches:
  only:
  - master
before_install:
- sudo apt-get -y install graphviz
- sudo apt-get -y install cpanminus
- sudo apt-get -y install libgraphviz-perl
- cpanm --local-lib=~/perl5 local::lib && eval $(perl -I ~/perl5/lib/perl5/ -Mlocal::lib)
- cpanm Module::Build
install:
- pip install -r model-desc/reqs.txt
- pushd make-model
- perl Build.PL
- yes | ./Build installdeps --cpan_client cpanm
- "./Build test --verbose"
- ls -lR .
- "./Build install"
script:
- popd
- pushd model-desc
- pytest && cp icdc-model.yml icdc-model-props.yml ../docs/model-desc && model-tool
  -g ../docs/model-desc/icdc-model.svg ../docs/model-desc/icdc-model.yml ../docs/model-desc/icdc-model-props.yml
deploy:
  provider: pages
  skip_cleanup: true
  local_dir: docs/model-desc
  github_token: $GITHUB_TOKEN
  keep_history: true
  verbose: true
  on:
    branch: master
